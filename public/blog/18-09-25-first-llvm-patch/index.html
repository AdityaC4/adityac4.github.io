<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aditya chaudhari</title>
    <link
      rel="icon"
      type="image/jpg"
      href="https://adityac4.github.io/images/face.jpg"
    />
    <link rel="stylesheet" href="https://adityac4.github.io/style.css" />
    <script>
      // Make all external links open in new tab
      document.addEventListener('DOMContentLoaded', function() {
        const links = document.querySelectorAll('a[href^="http"]');
        const currentDomain = window.location.hostname;
        
        links.forEach(link => {
          try {
            const linkUrl = new URL(link.href);
            // Only open external links in new tab, not internal navigation
            if (linkUrl.hostname !== currentDomain) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          } catch (e) {
            // If URL parsing fails, skip this link
            console.warn('Could not parse URL:', link.href);
          }
        });
      });
    </script>
  </head>

  <body>
    <section class="section">
      <div class="container">
        <!-- Navigation -->
        <nav class="nav">
          <div class="nav-container">
            <a href="https://adityac4.github.io" class="nav-brand">
              <img
                src="https://adityac4.github.io/images/face.jpg"
                alt="Aditya"
                class="nav-avatar"
              />
              aditya's blog
            </a>
            <ul class="nav-links">
              <li>
                <a href="https://adityac4.github.io" class="nav-link">/home</a>
              </li>
              <li>
                <a
                  href="https://adityac4.github.io/blog/"
                  class="nav-link"
                  >/posts</a
                >
              </li>
              <li>
                <a
                  href="https://adityac4.github.io/tags/"
                  class="nav-link"
                  >/tags</a
                >
              </li>
            </ul>
          </div>
        </nav>
        <div class="align-container">
          <!-- Main content -->
          
<article class="post">
  <header class="post-header">
    <div class="post-header-content">
      <div class="post-title-section">
        <h1 class="title">My First LLVM Patch: Making AVX/AVX512 Subvector Insert Intrinsics <code>constexpr</code></h1>
        
        <p class="post-description">Me actually learning LLVM</p>
        
      </div>
      <div class="post-meta">
        <div class="post-date">
          <strong>2025-09-18</strong>
        </div>
        
        <div class="post-tags">
          
          <a href="https://adityac4.github.io/tags/llvm/" class="tag"
            >LLVM</a
          >
          
          <a href="https://adityac4.github.io/tags/clang/" class="tag"
            >clang</a
          >
          
        </div>
        
      </div>
    </div>
  </header>

  <div class="post-content"><p>Recently I had decided to contribute my first patch to LLVM — a small but surprisingly tricky update to enable <code>constexpr</code> support for AVX and AVX512 subvector insert intrinsics. The kind of patch where you think "how hard can this be?" and then two days later you're debugging vector lanes in an interpreter VM you didn't know existed.</p>
<h2 id="the-why">The Why</h2>
<p>The goal: make intrinsics like <code>_mm256_insertf128_ps</code> usable in <code>constexpr</code> functions. These are commonly used in high-performance SIMD code, and enabling them in constant evaluation can help optimize compile-time expressions, especially when building vector tables or reshuffling constants.</p>
<h2 id="trying-it">Trying it</h2>
<p>I started with the most scientific approach available: I wrote a test case and waited for it to fail.</p>
<pre data-lang="cpp" style="background-color:#f9f9f9;color:#111111;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#8959a8;">constexpr</span><span> __m256 result </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">_mm256_insertf128_ps</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">_mm256_setzero_ps</span><span style="color:#4271ae;">(), </span><span style="color:#c82728;">_mm_set1_ps</span><span style="color:#4271ae;">(</span><span style="color:#f07219;">1.0</span><span style="color:#8959a8;">f</span><span style="color:#4271ae;">), </span><span style="color:#f07219;">1</span><span style="color:#4271ae;">)</span><span>;
</span></code></pre>
<p>And thankfully it failed. The constant evaluator didn't know what to do with the builtin, and the interpreter threw up its hands, gracefully.</p>
<h2 id="the-real-work">The Real Work</h2>
<p>To fix this, I had to teach both:</p>
<ul>
<li><code>ExprConstant.cpp</code>: Clang's AST evaluator, used for folding during semantic analysis.</li>
<li><code>InterpBuiltin.cpp</code>: the bytecode interpreter, which runs <code>constexpr</code> code on a tiny VM. (the future)</li>
</ul>
<p>The logic is the same in both:</p>
<ol>
<li>Take the base and subvector.</li>
<li>Check that their sizes are compatible.</li>
<li>Compute the insertion offset using the immediate operand.</li>
<li>Copy over the subvector lane into the base.</li>
</ol>
<p>It’s not hard logic. But LLVM’s interpreters work at a pretty low level, and everything is abstracted (you deal with <code>APValue</code> and <code>Pointer</code> wrappers, type metadata, etc). Every copy feels like handling memory with oven mitts.</p>
<h2 id="builtinsx86-td-the-treasure-map">BuiltinsX86.td: The Treasure Map</h2>
<p>Adding a new builtin means updating <code>BuiltinsX86.td</code>. This file maps frontend-level intrinsics to backend builtins and includes type info, masks, variants, etc.</p>
<p>It took me a while to understand that I didn’t need to reimplement any masking behavior. I had assumed I would need to manually interpret the mask register (“if bit i is set, write lane i”), but it turns out Clang’s headers expand these into separate builtins entirely, and the mask is passed through as a normal argument. Huge relief.</p>
<h2 id="testing-and-some-cleanup">Testing (and some cleanup)</h2>
<p>Originally I wrote a new file: <code>avx-insert-constexpr.cpp</code>. But I was gently nudged by reviewers to follow the existing structure and add tests in the appropriate <code>clang/test/CodeGen/X86</code> files.</p>
<p>So I did.</p>
<p>Over 40 new test cases, all using the <code>TEST_CONSTEXPR</code> macro to make sure the evaluation actually happens at compile time. Here's a representative one:</p>
<pre data-lang="c" style="background-color:#f9f9f9;color:#111111;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#8e908c;">// Yes, this is one line in the actual test
</span><span style="color:#c82728;">TEST_CONSTEXPR</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">match_v16si</span><span style="color:#4271ae;">(</span><span style="color:#c82728;">_mm512_mask_inserti32x4</span><span style="color:#4271ae;">(((__m512i)(__v16si){</span><span style="color:#f07219;">2</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">3</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">4</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">5</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">6</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">7</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">8</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">9</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">10</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">11</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">12</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">13</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">14</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">15</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">16</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">17</span><span style="color:#4271ae;">}), (</span><span style="color:#f07219;">0x00F0</span><span style="color:#4271ae;">), ((__m512i)(__v16si){</span><span style="color:#f07219;">2</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">3</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">4</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">5</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">6</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">7</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">8</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">9</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">10</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">11</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">12</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">13</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">14</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">15</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">16</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">17</span><span style="color:#4271ae;">}), ((__m128i)(__v4si){</span><span style="color:#f07219;">20</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">30</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">40</span><span style="color:#4271ae;">,</span><span style="color:#f07219;">50</span><span style="color:#4271ae;">}), </span><span style="color:#f07219;">1</span><span style="color:#4271ae;">), </span><span style="color:#f07219;">2</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">3</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">4</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">5</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">20</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">30</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">40</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">50</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">10</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">11</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">12</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">13</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">14</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">15</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">16</span><span style="color:#4271ae;">, </span><span style="color:#f07219;">17</span><span style="color:#4271ae;">))</span><span>;
</span></code></pre>
<p>Simple, but satisfying.</p>
<h2 id="review-feedback">Review Feedback</h2>
<p>Most of the comments were around naming (I had <code>DstVec</code>, <code>Dst</code>, <code>Result</code> all floating around with conflicting meanings) and LLVM's legendary formatting rules. There's a rule about 80 columns. It’s not just a suggestion.</p>
<pre data-lang="cpp" style="background-color:#f9f9f9;color:#111111;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#c82728;">assert</span><span style="color:#4271ae;">(SubElements </span><span style="color:#3e999f;">!= </span><span style="color:#f07219;">0 </span><span style="color:#3e999f;">&amp;&amp;</span><span style="color:#4271ae;"> BaseElements </span><span style="color:#3e999f;">!= </span><span style="color:#f07219;">0 </span><span style="color:#3e999f;">&amp;&amp; </span><span style="color:#4271ae;">(BaseElements </span><span style="color:#3e999f;">%</span><span style="color:#4271ae;"> SubElements) </span><span style="color:#3e999f;">== </span><span style="color:#f07219;">0</span><span style="color:#4271ae;">)</span><span>;
</span></code></pre>
<p>That became:</p>
<pre data-lang="cpp" style="background-color:#f9f9f9;color:#111111;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#4271ae;">assert(SubElements </span><span style="color:#3e999f;">!= </span><span style="color:#f07219;">0 </span><span style="color:#3e999f;">&amp;&amp;</span><span style="color:#4271ae;"> BaseElements </span><span style="color:#3e999f;">!= </span><span style="color:#f07219;">0 </span><span style="color:#3e999f;">&amp;&amp;
</span><span style="color:#4271ae;">       (BaseElements </span><span style="color:#3e999f;">%</span><span style="color:#4271ae;"> SubElements) </span><span style="color:#3e999f;">== </span><span style="color:#f07219;">0</span><span style="color:#4271ae;">)</span><span>;
</span></code></pre>
<p>(The reviewers and the llvm bot <em>will</em> notice.)</p>
<h2 id="merge">Merge!</h2>
<p>Eventually, the reviewers signed off. CI passed. I rebased, squashed, and hit "Mark as ready". A few hours later, it was merged.</p>
<p>🎉 First LLVM patch in!</p>
<p>PR: <a href="https://github.com/llvm/llvm-project/pull/158778">llvm/llvm-project/pull/158778</a></p>
<p>Issue: <a href="https://github.com/llvm/llvm-project/issues/157709">#157709</a></p>
<h2 id="closing-thoughts">Closing Thoughts</h2>
<p>I learned more than I expected:</p>
<ul>
<li>About <code>constexpr</code>, sure. But also about Clang internals, how intrinsics flow through the frontend, and the lovely balance between AST and interpreter.</li>
<li>LLVM has a steep curve, but the community’s been welcoming and helpful. (Special thanks to @RKSimon and @tbaederr!)</li>
<li>It felt good to contribute something useful. Even if it's "just" <code>constexpr</code> for a few AVX intrinsics, it's a real feature used by real code.</li>
</ul>
<p><img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExeTg3YTY0MGZ0cnVsNDEwemg1bjM1dWV0ZGMyaWt4aWc4NjZja3c0dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/BMR4cgypuglVu/giphy.gif" alt="fabulous cat" /></p>
</div>
</article>

        </div>
      </div>
    </section>
  </body>
</html>
